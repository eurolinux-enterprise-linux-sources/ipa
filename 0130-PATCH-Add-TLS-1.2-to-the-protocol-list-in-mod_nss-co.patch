From 96b24e52a89ccbdcaf97c10af3968c5164b7b667 Mon Sep 17 00:00:00 2001
From: Petr Vobornik <pvoborni@redhat.com>
Date: Wed, 4 Mar 2015 13:58:26 +0100
Subject: [PATCH] Add TLS 1.2 to the protocol list in mod_nss config

https://fedorahosted.org/freeipa/ticket/4653

Reviewed-By: Martin Kosek <mkosek@redhat.com>
---
 install/tools/ipa-upgradeconfig   | 13 +++++++++++++
 ipaserver/install/httpinstance.py |  5 +++++
 2 files changed, 18 insertions(+)

diff --git a/install/tools/ipa-upgradeconfig b/install/tools/ipa-upgradeconfig
index 761724e9a9c284dbb7211bb14766b618e842e1f3..18a74c730e1802b833afad6ad20c9f31c32bd7c1 100644
--- a/install/tools/ipa-upgradeconfig
+++ b/install/tools/ipa-upgradeconfig
@@ -617,6 +617,18 @@ def migrate_crl_publish_dir(ca):
                      'request pki-ca restart')
     return True
 
+def update_mod_nss_protocol(http):
+    root_logger.info('[Updating mod_nss protocol versions]')
+
+    if sysupgrade.get_upgrade_state('nss.conf', 'protocol_updated_tls12'):
+        root_logger.info("Protocol versions already updated")
+        return
+
+    http.set_mod_nss_protocol()
+
+    sysupgrade.set_upgrade_state('nss.conf', 'protocol_updated_tls12', True)
+
+
 def main():
     """
     Get some basics about the system. If getting those basics fail then
@@ -688,6 +700,7 @@ def main():
     http = httpinstance.HTTPInstance(fstore)
     http.remove_httpd_ccache()
     http.configure_selinux_for_httpd()
+    update_mod_nss_protocol(http)
 
     memcache = memcacheinstance.MemcacheInstance()
     memcache.ldapi = True
diff --git a/ipaserver/install/httpinstance.py b/ipaserver/install/httpinstance.py
index 5c35b5cd2728a56e7c81315392b758f69c1375ae..925ce5845f6982230b45a3e47b955f903028e43a 100644
--- a/ipaserver/install/httpinstance.py
+++ b/ipaserver/install/httpinstance.py
@@ -85,6 +85,8 @@ class HTTPInstance(service.Service):
 
         self.step("disabling mod_ssl in httpd", self.__disable_mod_ssl)
         self.step("setting mod_nss port to 443", self.__set_mod_nss_port)
+        self.step("setting mod_nss protocol list to TLSv1.0 - TLSv1.2",
+                  self.set_mod_nss_protocol)
         self.step("setting mod_nss password file", self.__set_mod_nss_passwordfile)
         self.step("enabling mod_nss renegotiate", self.enable_mod_nss_renegotiate)
         self.step("adding URL rewriting rules", self.__add_include)
@@ -219,6 +221,9 @@ class HTTPInstance(service.Service):
     def __set_mod_nss_nickname(self, nickname):
         installutils.set_directive(NSS_CONF, 'NSSNickname', nickname)
 
+    def set_mod_nss_protocol(self):
+        installutils.set_directive(NSS_CONF, 'NSSProtocol', 'TLSv1.0,TLSv1.1,TLSv1.2', False)
+
     def enable_mod_nss_renegotiate(self):
         installutils.set_directive(NSS_CONF, 'NSSRenegotiation', 'on', False)
         installutils.set_directive(NSS_CONF, 'NSSRequireSafeNegotiation', 'on', False)
-- 
2.4.3

