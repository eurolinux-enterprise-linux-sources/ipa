From 9cc17354fce7036b30d1d95a027143b3bc8b9270 Mon Sep 17 00:00:00 2001
From: Jan Cholasta <jcholast@redhat.com>
Date: Wed, 18 Jun 2014 15:26:17 +0200
Subject: [PATCH] Do not corrupt sshd_config in client install when trailing
 newline is missing.

https://fedorahosted.org/freeipa/ticket/4373
---
 ipa-client/ipa-install/ipa-client-install | 42 +++++++++++++------------------
 1 file changed, 17 insertions(+), 25 deletions(-)

diff --git a/ipa-client/ipa-install/ipa-client-install b/ipa-client/ipa-install/ipa-client-install
index e1f4af9f4c3ff0af4cf79ec794fe5fc6df47136e..a73a26c166883a4301e4d53518cd4ea27fd6df16 100755
--- a/ipa-client/ipa-install/ipa-client-install
+++ b/ipa-client/ipa-install/ipa-client-install
@@ -1207,7 +1207,7 @@ def configure_sssd_conf(fstore, cli_realm, cli_domain, cli_server, options, clie
     return 0
 
 def change_ssh_config(filename, changes, sections):
-    if len(changes) == 0:
+    if not changes:
         return True
 
     try:
@@ -1216,38 +1216,30 @@ def change_ssh_config(filename, changes, sections):
         root_logger.error("Failed to open '%s': %s", filename, str(e))
         return False
 
+    change_keys = tuple(key.lower() for key in changes)
+    section_keys = tuple(key.lower() for key in sections)
+
     lines = []
-    in_section = False
     for line in f:
-        if in_section:
-            lines.append(line)
-            continue
+        line = line.rstrip('\n')
         pline = line.strip()
-        if len(pline) == 0 or pline.startswith('#'):
+        if not pline or pline.startswith('#'):
             lines.append(line)
             continue
-        parts = pline.split()
-        option = parts[0].lower()
-        for key in sections:
-            if key.lower() == option:
-                in_section = True
-                break
-        if in_section:
+        option = pline.split()[0].lower()
+        if option in section_keys:
+            lines.append(line)
             break
-        for opt in changes:
-            if opt.lower() == option:
-                line = None
-                break
-        if line is not None:
-            lines.append(line)
-    for opt in changes:
-        if changes[opt] is not None:
-            lines.append('%s %s\n' % (opt, changes[opt]))
-    lines.append('\n')
-    if in_section:
+        if option in change_keys:
+            line = '#' + line
         lines.append(line)
+    for option, value in changes.items():
+        if value is not None:
+            lines.append('%s %s' % (option, value))
     for line in f:
+        line = line.rstrip('\n')
         lines.append(line)
+    lines.append('')
 
     f.close()
 
@@ -1257,7 +1249,7 @@ def change_ssh_config(filename, changes, sections):
         root_logger.error("Failed to open '%s': %s", filename, str(e))
         return False
 
-    f.write(''.join(lines))
+    f.write('\n'.join(lines))
 
     f.close()
 
-- 
2.1.0

