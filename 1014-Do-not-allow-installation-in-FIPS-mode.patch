From f84bc9ff9e466a016c3fe143f11390d0f612efd6 Mon Sep 17 00:00:00 2001
From: Petr Vobornik <pvoborni@redhat.com>
Date: Fri, 27 Feb 2015 10:18:34 +0100
Subject: [PATCH] Do not allow installation in FIPS mode

https://bugzilla.redhat.com/show_bug.cgi?id=1131571
---
 install/tools/ipa-replica-install         | 5 +++++
 install/tools/ipa-server-install          | 5 +++++
 install/tools/ipactl                      | 6 ++++++
 ipa-client/ipa-install/ipa-client-install | 4 ++++
 4 files changed, 20 insertions(+)

diff --git a/install/tools/ipa-replica-install b/install/tools/ipa-replica-install
index f7cf023bbccd512e109d63cd0a3d77246a48d308..81c964b783ad0c994ea708744b394c95edb9e45a 100755
--- a/install/tools/ipa-replica-install
+++ b/install/tools/ipa-replica-install
@@ -302,6 +302,11 @@ def main():
     if os.geteuid() != 0:
         sys.exit("\nYou must be root to run this script.\n")
 
+    if os.path.exists('/proc/sys/crypto/fips_enabled'):
+        with open('/proc/sys/crypto/fips_enabled', 'r') as f:
+            if f.read().strip() != '0':
+                sys.exit("Cannot install IPA server in FIPS mode")
+
     standard_logging_setup(log_file_name, debug=options.debug)
     root_logger.debug('%s was invoked with argument "%s" and options: %s' % (sys.argv[0], filename, safe_options))
 
diff --git a/install/tools/ipa-server-install b/install/tools/ipa-server-install
index 7180a214cc02dbd959cd9714030b008a19afb11c..7fed3c0f4292a4d87784811d367a138e10ad94b5 100755
--- a/install/tools/ipa-server-install
+++ b/install/tools/ipa-server-install
@@ -563,6 +563,11 @@ def main():
     if os.getegid() != 0:
         sys.exit("Must be root to set up server")
 
+    if os.path.exists('/proc/sys/crypto/fips_enabled'):
+        with open('/proc/sys/crypto/fips_enabled', 'r') as f:
+            if f.read().strip() != '0':
+                sys.exit("Cannot install IPA server in FIPS mode")
+
     ipaservices.check_selinux_status()
 
     signal.signal(signal.SIGTERM, signal_handler)
diff --git a/install/tools/ipactl b/install/tools/ipactl
index d4b2c0878f2b62fd12198f76bef01ef70e9f3de1..e22cb2e0c102b676ba1c8cad69e6808d6b475563 100755
--- a/install/tools/ipactl
+++ b/install/tools/ipactl
@@ -352,6 +352,12 @@ def main():
     elif args[0] != "start" and args[0] != "stop" and args[0] != "restart" and args[0] != "status":
         raise IpactlError("Unrecognized action [" + args[0] + "]", 2)
 
+    if (args[0] in ('start', 'restart') and
+        os.path.exists('/proc/sys/crypto/fips_enabled')):
+        with open('/proc/sys/crypto/fips_enabled', 'r') as f:
+            if f.read().strip() != '0':
+                raise IpactlError("Cannot start IPA server in FIPS mode")
+
     # check if IPA is configured at all
     try:
         check_IPA_configuration()
diff --git a/ipa-client/ipa-install/ipa-client-install b/ipa-client/ipa-install/ipa-client-install
index 819e4eb55d8f6c8aade9e50e4b3b015ab6ccac3a..21592b436ee8aab0bc1fcf1a12627671f8cba290 100755
--- a/ipa-client/ipa-install/ipa-client-install
+++ b/ipa-client/ipa-install/ipa-client-install
@@ -2485,6 +2485,10 @@ def main():
 
     if not os.getegid() == 0:
         sys.exit("\nYou must be root to run ipa-client-install.\n")
+    if os.path.exists('/proc/sys/crypto/fips_enabled'):
+        with open('/proc/sys/crypto/fips_enabled', 'r') as f:
+            if f.read().strip() != '0':
+                sys.exit("Cannot install IPA client in FIPS mode")
     ipaservices.check_selinux_status()
     logging_setup(options)
     root_logger.debug(
-- 
2.1.0

