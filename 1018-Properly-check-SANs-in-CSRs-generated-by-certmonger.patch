From 4341feed5a2a61ebb1bc2fdf833ff4edf3b0ab3c Mon Sep 17 00:00:00 2001
From: Jan Cholasta <jcholast@redhat.com>
Date: Wed, 1 Apr 2015 06:11:00 +0200
Subject: [PATCH] Properly check SANs in CSRs generated by certmonger

https://bugzilla.redhat.com/show_bug.cgi?id=1207649
---
 ipalib/pkcs10.py | 7 ++++++-
 1 file changed, 6 insertions(+), 1 deletion(-)

diff --git a/ipalib/pkcs10.py b/ipalib/pkcs10.py
index 29f9b3520fdc8089dfc6b0072406449286a13ea2..9d652cf37e5c7e3473c97793a08f44fa13a1324f 100644
--- a/ipalib/pkcs10.py
+++ b/ipalib/pkcs10.py
@@ -27,6 +27,8 @@ from ipalib import api
 PEM = 0
 DER = 1
 
+SAN_DNSNAME = 'DNS name'
+
 def get_subjectaltname(request):
     """
     Given a CSR return the subjectaltname value, if any.
@@ -35,7 +37,10 @@ def get_subjectaltname(request):
     """
     for extension in request.extensions:
         if extension.oid_tag  == nss.SEC_OID_X509_SUBJECT_ALT_NAME:
-            return nss.x509_alt_name(extension.value)
+            return tuple(name.name
+                         for name in nss.x509_alt_name(extension.value,
+                                                       nss.AsObject)
+                         if name.type_name == SAN_DNSNAME)
     return None
 
 def get_subject(request):
-- 
2.1.0

