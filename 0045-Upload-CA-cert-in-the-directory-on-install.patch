From e9deb54737deb984eb45b213c27eab0093334298 Mon Sep 17 00:00:00 2001
From: Simo Sorce <simo@redhat.com>
Date: Mon, 12 Nov 2012 17:43:05 -0500
Subject: [PATCH 1/4] Upload CA cert in the directory on install

This will later allow clients to securely download the CA cert by
performaing mutual auth using LDAP with GSSAPI
---
 install/share/Makefile.am        |    1 +
 install/share/upload-cacert.ldif |    7 +++++++
 ipaserver/install/dsinstance.py  |   15 +++++++++++++++
 3 files changed, 23 insertions(+), 0 deletions(-)
 create mode 100644 install/share/upload-cacert.ldif

diff --git a/install/share/Makefile.am b/install/share/Makefile.am
index 7f953bc4261b9158303e166fd5c5f1c1232986e4..7ec14f3edc16c2aa29850ce195d82d7e8d152657 100644
--- a/install/share/Makefile.am
+++ b/install/share/Makefile.am
@@ -60,6 +60,7 @@ app_DATA =				\
 	automember.ldif			\
 	replica-automember.ldif		\
 	replica-s4u2proxy.ldif		\
+	upload-cacert.ldif		\
 	$(NULL)
 
 EXTRA_DIST =				\
diff --git a/install/share/upload-cacert.ldif b/install/share/upload-cacert.ldif
new file mode 100644
index 0000000000000000000000000000000000000000..d2087d8e216f76210e7ebe3fe0970c9273e8f466
--- /dev/null
+++ b/install/share/upload-cacert.ldif
@@ -0,0 +1,7 @@
+# add CA certificate to LDAP server
+dn: cn=CAcert,cn=ipa,cn=etc,$SUFFIX
+changetype: add
+objectClass: nsContainer
+objectClass: pkiCA
+cn: CAcert
+cACertificate;binary:: $CADERCERT
diff --git a/ipaserver/install/dsinstance.py b/ipaserver/install/dsinstance.py
index b48e7d7681b585a3f348cfe08b35ea8f723c0485..7550f73e7d859a7c491c4d1ee63297b13013ae5c 100644
--- a/ipaserver/install/dsinstance.py
+++ b/ipaserver/install/dsinstance.py
@@ -43,6 +43,7 @@ from ipaserver.install import replication
 from ipalib import util, errors
 from ipapython.dn import DN
 from ipaserver.plugins.ldap2 import ldap2
+import base64
 
 SERVER_ROOT_64 = "/usr/lib64/dirsrv"
 SERVER_ROOT_32 = "/usr/lib/dirsrv"
@@ -258,6 +259,7 @@ class DsInstance(service.Service):
         self.step("adding range check plugin", self.__add_range_check_plugin)
         if hbac_allow:
             self.step("creating default HBAC rule allow_all", self.add_hbac)
+        self.step("Upload CA cert to the directory", self.__upload_ca_cert)
 
         self.__common_post_setup()
 
@@ -587,6 +589,19 @@ class DsInstance(service.Service):
         # check for open secure port 636 from now on
         self.open_ports.append(636)
 
+    def __upload_ca_cert(self):
+        """
+        Upload the CA certificate in DER form in the LDAP directory.
+        """
+
+        dirname = config_dirname(self.serverid)
+        certdb = certs.CertDB(self.realm_name, nssdir=dirname, subject_base=self.subject_base)
+
+        dercert = certdb.get_cert_from_db(certdb.cacert_name, pem=False)
+        self.sub_dict['CADERCERT'] = base64.b64encode(dercert)
+
+        self._ldap_mod('upload-cacert.ldif', self.sub_dict)
+
     def __add_default_layout(self):
         self._ldap_mod("bootstrap-template.ldif", self.sub_dict)
 
-- 
1.7.1

